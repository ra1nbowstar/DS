# 项目结构说明文档

## 项目概述

本项目是一个基于 FastAPI 开发的综合管理系统，采用分层架构设计，包含财务管理系统、用户中心、订单系统和商品管理四大核心模块。项目使用 PyMySQL 作为数据库操作层，完全移除了 SQLAlchemy ORM，采用纯 SQL 方式进行数据库交互。

## 技术栈

- **Web 框架**: FastAPI 0.123.9+
- **数据库**: MySQL (通过 PyMySQL 1.1.2+ 连接)
- **数据验证**: Pydantic 2.12.5+
- **认证**: PyJWT 2.9.0+ (JWT Token)
- **密码加密**: bcrypt 4.2.0+
- **HTTP 客户端**: requests 2.32.0+
- **配置管理**: python-dotenv 1.2.1+
- **ASGI 服务器**: uvicorn 0.38.0+
- **图像处理**: Pillow 12.0.0+
- **拼音处理**: pypinyin 0.55.0+
- **文件上传**: python-multipart 0.0.20+

## 项目目录结构

```
DS/
├── api/                    # API 路由层
├── assets/                 # 静态资源文件
├── core/                   # 核心基础模块
├── logs/                   # 日志文件目录
├── models/                 # 数据模型层
├── services/               # 业务逻辑层
├── database_setup.py       # 数据库初始化脚本
├── main.py                 # 应用入口文件
├── pyproject.toml          # 项目依赖配置
├── README.md               # 项目说明文档
└── uv.lock                 # 依赖锁定文件
```

---

## 详细目录说明

### 📁 api/ - API 路由层

API 路由层负责定义所有的 HTTP 接口端点，处理请求参数验证、调用服务层方法并返回响应。

#### 📁 api/finance/ - 财务系统 API

**routes.py** - 财务系统相关的所有 API 路由

**依赖注入函数**:
- `get_finance_service() -> FinanceService`: 获取财务服务实例（FastAPI 依赖注入）
- `get_database_manager() -> DatabaseManager`: 获取数据库管理器实例（FastAPI 依赖注入）

**API 路由函数** (共 30+ 个接口):
- `GET /` - 系统状态检查
- `POST /api/init` - 初始化数据库表结构
- `POST /api/init-data` - 创建测试数据
- `POST /api/users` - 创建用户
- `GET /api/users/{user_id}` - 查询用户信息
- `POST /api/users/set-referrer` - 设置推荐人
- `GET /api/users/{user_id}/referrer` - 查询推荐人
- `GET /api/users/{user_id}/team` - 查询团队下线
- `POST /api/products` - 创建商品
- `GET /api/products` - 查询商品列表
- `POST /api/orders` - 订单结算
- `POST /api/orders/refund` - 订单退款
- `POST /api/orders/use-coupon` - 使用优惠券
- `POST /api/submit-test-order` - 提交测试订单
- `POST /api/subsidy/distribute` - 发放周补贴
- `POST /api/subsidy/fund` - 预存补贴资金
- `GET /api/public-welfare` - 查询公益基金余额
- `GET /api/public-welfare/flow` - 公益基金流水明细
- `GET /api/admin/reports/public-welfare` - 公益基金交易报表
- `POST /api/withdrawals` - 申请提现
- `PATCH /api/withdrawals/audit` - 审核提现
- `POST /api/rewards/audit` - 批量审核奖励
- `GET /api/rewards/pending` - 查询奖励列表
- `GET /api/coupons/{user_id}` - 查询用户优惠券
- `GET /api/reports/finance` - 财务总览报告
- `GET /api/reports/account-flow` - 资金流水报告
- `GET /api/reports/points-flow` - 积分流水报告
- `GET /api/admin/reports/points-deduction` - 积分抵扣明细报表
- `POST /api/directors/check-promotion` - 执行荣誉董事晋升
- `GET /api/admin/reports/transaction-chain` - 交易推荐链报表
- `POST /api/orders/test-reward-chain` - 测试层级返利
- `DELETE /api/cleanup` - 清理测试数据

**路由注册函数**:
- `register_finance_routes(app: FastAPI)`: 注册所有财务系统路由到 FastAPI 应用

#### 📁 api/user/ - 用户中心 API

**routes.py** - 用户中心相关的所有 API 路由

**辅助函数**:
- `_err(msg: str)`: 错误响应辅助函数

**路由注册函数**:
- `register_routes(app: FastAPI)`: 注册所有用户中心路由

**API 路由函数** (共 25+ 个接口):
- `POST /user/set-status` - 冻结/注销/恢复正常
- `POST /user/auth` - 一键登录（不存在则自动注册）
- `POST /user/wechat-login` - 微信小程序登录
- `POST /user/update-profile` - 修改资料（昵称/头像/密码）
- `POST /user/self-delete` - 用户自助注销账号
- `PUT /user/freeze` - 后台冻结用户
- `PUT /user/unfreeze` - 后台解冻用户
- `POST /user/reset-password` - 找回密码（短信验证）
- `PUT /admin/user/reset-pwd` - 后台重置用户密码
- `POST /user/upgrade` - 升 1 星
- `POST /user/set-level` - 后台调星
- `GET /user/info` - 用户详情（个人中心）
- `GET /user/list` - 分页列表+筛选
- `POST /user/bind-referrer` - 绑定推荐人
- `GET /user/refer-direct` - 直推列表
- `GET /user/refer-team` - 团队列表（递归）
- `POST /address` - 新增地址
- `PUT /address/default` - 把已有地址设为默认
- `DELETE /address/{addr_id}` - 删除地址
- `GET /address/list` - 地址列表
- `POST /address/return` - 商家设置退货地址
- `GET /address/return` - 查看退货地址
- `POST /points` - 增减积分
- `GET /points/balance` - 积分余额
- `GET /points/log` - 积分流水
- `GET /reward/list` - 我的团队奖励
- `GET /reward/by-order/{order_id}` - 按订单查看奖励
- `POST /director/try-promote` - 晋升荣誉董事
- `GET /director/is` - 是否荣誉董事
- `GET /director/dividend` - 分红明细
- `GET /director/list` - 所有活跃董事

#### 📁 api/order/ - 订单系统 API

**__init__.py** - 订单模块路由注册入口

**路由注册函数**:
- `register_routes(app: FastAPI)`: 统一注册所有订单相关路由到主应用，包括购物车、订单、退款、商家等路由
  - **注意**：地址管理功能已统一整合到用户系统中，订单系统不再包含地址相关路由

**cart.py** - 购物车相关接口

**类**:
- `CartManager`: 购物车管理器类
  - `get_cart(user_id: int)`: 获取用户购物车列表
  - `add_item(user_id: int, product_id: int, quantity: int)`: 添加商品到购物车
  - `remove_item(user_id: int, product_id: int)`: 从购物车移除商品
  - `update_quantity(user_id: int, product_id: int, quantity: int)`: 更新购物车商品数量
  - `clear_cart(user_id: int)`: 清空购物车

**数据模型**:
- `CartAdd`: 添加购物车请求模型

**API 路由函数**:
- `GET /cart/{user_id}` - 获取购物车列表
- `POST /cart/add` - 添加商品到购物车
- `DELETE /cart/{user_id}/{product_id}` - 从购物车移除商品

**order.py** - 订单管理接口

**类**:
- `OrderManager`: 订单管理器类
  - `create_order(user_id: int, items: list, address_id: int)`: 创建订单
  - `get_order_list(user_id: int, status: str = None, page: int = 1, size: int = 10)`: 查询订单列表
  - `get_order_detail(order_id: int)`: 查询订单详情
  - `update_order_status(order_id: int, status: str)`: 更新订单状态
  - `pay_order(order_id: int, pay_way: str)`: 订单支付

**数据模型**:
- `OrderCreate`: 创建订单请求模型
- `OrderPay`: 订单支付请求模型
- `StatusUpdate`: 状态更新请求模型

**API 路由函数**:
- `POST /order/create` - 创建订单
- `GET /order/list` - 查询订单列表
- `GET /order/{order_id}` - 查询订单详情
- `POST /order/pay` - 订单支付
- `PUT /order/status` - 更新订单状态

**refund.py** - 退款相关接口

**API 路由函数**:
- `POST /refund/apply` - 申请退款
- `GET /refund/list` - 查询退款记录
- `POST /refund/audit` - 退款审核

**注意**：地址管理功能已统一整合到用户系统中，请使用 `api/user/routes.py` 中的地址相关接口和 `services/address_service.py` 中的 `AddressService` 类。

**merchant.py** - 商家后台接口

**类**:
- `MerchantManager`: 商家管理器类
  - `get_orders(status: str = None)`: 查询商家订单列表
  - `ship_order(order_id: int, tracking_number: str)`: 订单发货
  - `approve_refund(refund_id: int, approve: bool)`: 审核退款申请
  - `get_balance()`: 查询账户余额
  - `bind_bank(bank_name: str, bank_account: str)`: 绑定银行卡
  - `withdraw(amount: Decimal)`: 申请提现

**数据模型**:
- `MShip`: 发货请求模型
- `MRefundAudit`: 退款审核请求模型
- `MBindBank`: 绑定银行卡请求模型
- `MWithdraw`: 提现请求模型

**API 路由函数**:
- `GET /merchant/orders` - 查询订单列表
- `POST /merchant/ship` - 订单发货
- `POST /merchant/approve_refund` - 审核退款申请
- `GET /merchant/balance` - 查询账户余额
- `POST /merchant/bind_bank` - 绑定银行卡
- `POST /merchant/withdraw` - 申请提现

**fasteners.py** - 紧固件相关接口（特殊业务模块）

**函数**:
- `auto_receive_task()`: 自动收货任务（后台守护进程）

#### 📁 api/product/ - 商品管理 API

**routes.py** - 商品管理相关的所有 API 路由

**API 路由函数**:
- `GET /product/search` - 商品搜索
- `GET /product/list` - 商品列表
- `GET /product/{id}` - 商品详情
- `POST /product/create` - 商品创建
- `PUT /product/update` - 商品更新
- `POST /product/upload-image` - 商品图片上传
- `GET /product/banner/list` - 轮播图列表
- `POST /product/banner/add` - 添加轮播图
- `DELETE /product/banner/{id}` - 删除轮播图
- `GET /product/sales/stats` - 销售数据统计

**路由注册函数**:
- `register_routes(app: FastAPI)`: 注册所有商品管理路由

**ext.py** - 商品扩展功能接口

提供商品相关的扩展功能接口。

---

### 📁 core/ - 核心基础模块

核心模块提供项目的基础设施和通用功能，所有其他模块都依赖这些核心组件。

#### **config.py** - 统一配置管理

**函数**:
- `get_db_config() -> dict`: 获取数据库配置字典，从环境变量读取 MySQL 配置（host, port, user, password, database, charset）

**常量**:
- `PLATFORM_MERCHANT_ID: Final[int] = 0`: 平台商家 ID
- `MEMBER_PRODUCT_PRICE: Final[Decimal] = Decimal('1980.00')`: 会员商品价格

**枚举类**:
- `AllocationKey(StrEnum)`: 资金分配类型枚举
  - `PUBLIC_WELFARE = 'public_welfare'`: 公益基金
  - `PLATFORM = 'platform'`: 平台
  - `SUBSIDY_POOL = 'subsidy_pool'`: 补贴池
  - `HONOR_DIRECTOR = 'honor_director'`: 荣誉董事
  - `COMMUNITY = 'community'`: 社区
  - `CITY_CENTER = 'city_center'`: 城市中心
  - `REGION_COMPANY = 'region_company'`: 区域公司
  - `DEVELOPMENT = 'development'`: 发展基金
  - `PLATFORM_REVENUE_POOL = 'platform_revenue_pool'`: 平台收入池
  - `COMPANY_POINTS = 'company_points'`: 公司积分
  - `COMPANY_BALANCE = 'company_balance'`: 公司余额

- `UserStatus(IntEnum)`: 用户状态枚举
  - `NORMAL = 1`: 正常
  - `HONOR_DIRECTOR = 9`: 荣誉董事

- `RewardType(StrEnum)`: 奖励类型枚举
  - `REFERRAL = 'referral'`: 推荐奖励
  - `TEAM = 'team'`: 团队奖励

- `RewardStatus(StrEnum)`: 奖励状态枚举
  - `PENDING = 'pending'`: 待审核
  - `APPROVED = 'approved'`: 已通过
  - `REJECTED = 'rejected'`: 已拒绝

- `CouponType(StrEnum)`: 优惠券类型枚举
  - `USER = 'user'`: 用户优惠券
  - `MERCHANT = 'merchant'`: 商家优惠券

- `CouponStatus(StrEnum)`: 优惠券状态枚举
  - `UNUSED = 'unused'`: 未使用
  - `USED = 'used'`: 已使用
  - `EXPIRED = 'expired'`: 已过期

- `WithdrawalStatus(StrEnum)`: 提现状态枚举
  - `PENDING_AUTO = 'pending_auto'`: 待自动审核
  - `PENDING_MANUAL = 'pending_manual'`: 待手动审核
  - `APPROVED = 'approved'`: 已通过
  - `REJECTED = 'rejected'`: 已拒绝

- `RefundStatus(StrEnum)`: 退款状态枚举
  - `APPLIED = 'applied'`: 已申请
  - `SELLER_OK = 'seller_ok'`: 商家同意
  - `SUCCESS = 'success'`: 退款成功
  - `REJECTED = 'rejected'`: 已拒绝

- `OrderStatus(StrEnum)`: 订单状态枚举
  - `PENDING_PAY = 'pending_pay'`: 待支付
  - `PENDING_SHIP = 'pending_ship'`: 待发货
  - `PENDING_RECV = 'pending_recv'`: 待收货
  - `COMPLETED = 'completed'`: 已完成
  - `REFUND = 'refund'`: 退款中
  - `REFUNDED = 'refunded'`: 已退款

**字典常量**:
- `ALLOCATIONS: Final[dict[AllocationKey, Decimal]]`: 资金分配比例字典，定义订单金额的分配比例
- `VALID_PAY_WAYS: Final[set[str]]`: 有效支付方式集合 {"alipay", "wechat", "card", "wx_pub", "wx_app"}
- `CATEGORY_CHOICES: Final[list[str]]`: 商品分类白名单列表

**业务规则常量**:
- `MAX_POINTS_VALUE: Final[Decimal] = Decimal('0.02')`: 最大积分价值
- `TAX_RATE: Final[Decimal] = Decimal('0.06')`: 提现税率
- `POINTS_DISCOUNT_RATE: Final[Decimal] = Decimal('1.0')`: 积分抵扣比例
- `COUPON_VALID_DAYS: Final[int] = 30`: 优惠券有效期（天）
- `MAX_PURCHASE_PER_DAY: Final[int] = 2`: 每日最大购买次数
- `MAX_TEAM_LAYER: Final[int] = 6`: 最大团队层级

**路径常量**:
- `LOG_DIR: Final[str]`: 日志目录路径
- `LOG_FILE: Final[str]`: 日志文件路径 (`logs/api.log`)
- `BASE_PIC_DIR: Final[Path]`: 图片上传基础目录 (`pic_data/`)

**微信配置**:
- `WECHAT_APP_ID: Final[str]`: 微信小程序 AppID（从环境变量读取）
- `WECHAT_APP_SECRET: Final[str]`: 微信小程序 AppSecret（从环境变量读取）
- `Wechat_ID: Final[dict]`: 微信配置字典（向后兼容）

#### **database.py** - 数据库连接管理

**函数**:
- `get_db_config_cached() -> dict`: 获取缓存的数据库配置（避免重复读取环境变量）
- `get_conn()`: 数据库连接上下文管理器（统一入口）
  - 使用 PyMySQL 建立连接
  - 自动管理事务（失败时回滚）
  - 使用 DictCursor 返回字典格式结果
  - 连接自动关闭
- `get_cursor()`: 获取数据库游标的上下文管理器（便捷方法）
- `execute_query(sql: str, params: Optional[tuple] = None) -> list`: 执行查询并返回结果列表
- `execute_one(sql: str, params: Optional[tuple] = None) -> Optional[dict]`: 执行查询并返回单条结果
- `execute_update(sql: str, params: Optional[tuple] = None) -> int`: 执行更新/插入/删除操作，返回受影响的行数
- `execute_insert(sql: str, params: Optional[tuple] = None) -> int`: 执行插入操作并返回插入的 ID
- `execute_transaction(operations: list) -> bool`: 执行事务操作（多个 SQL 操作），返回是否成功

#### **db_adapter.py** - 数据库适配器

数据库操作适配器，封装 PyMySQL 连接和游标操作，提供统一的数据库操作接口。

**类**:
- `PyMySQLAdapter`: 数据库会话适配器类，封装 PyMySQL 连接和事务管理
  - `__init__()`: 初始化适配器
  - `begin()`: 开始事务（上下文管理器）
  - `execute(sql: str, params: Optional[Dict[str, Any]] = None)`: 执行 SQL 语句（支持命名参数格式 `:param`，自动转换为 `%s`）
  - `_convert_sql_params(sql: str, params: Dict[str, Any]) -> tuple`: 将命名参数格式转换为 PyMySQL 的 `%s` 格式
  - `commit()`: 提交事务
  - `rollback()`: 回滚事务
  - `close()`: 关闭连接
  - `__enter__()`, `__exit__()`: 支持上下文管理器模式

- `ResultProxy`: 数据库查询结果代理类，封装查询结果并提供便捷的访问方法
  - `__init__(cursor: pymysql.cursors.DictCursor)`: 初始化结果代理
  - `fetchone()`: 获取单行结果，返回 `RowProxy` 对象
  - `fetchall()`: 获取所有结果，返回 `RowProxy` 对象列表
  - `lastrowid`: 获取最后插入的 ID（属性）
  - `rowcount`: 获取受影响的行数（属性）

- `RowProxy`: 数据库行数据代理类，支持属性访问和字典访问两种方式
  - `__init__(row: Dict)`: 初始化行代理
  - `__getattr__(name: str)`: 支持属性访问，如 `row.balance`
  - `__getitem__(key: str)`: 支持字典访问，如 `row['balance']`
  - `__contains__(key: str)`: 支持 `in` 操作
  - `get(key: str, default=None)`: 字典风格的 get 方法

#### **middleware.py** - 中间件配置

**函数**:
- `setup_cors(app: FastAPI)`: 配置 CORS 跨域中间件
  - 允许所有来源 (`allow_origins=["*"]`)
  - 允许所有方法和请求头
  - 允许携带凭证
- `setup_static_files(app: FastAPI)`: 配置静态文件服务
  - 仅在 `static/` 目录存在时挂载
  - 挂载路径: `/static`
  - 失败时静默忽略（不打印警告）

#### **logging.py** - 统一日志配置

项目统一的日志配置模块，确保整个项目的日志格式和输出方式一致。

**函数**:
- `setup_logging(level: int = logging.INFO, log_to_file: bool = True, log_to_console: bool = False, log_format: str = None) -> None`: 统一配置日志系统
  - `level`: 日志级别，默认为 INFO
  - `log_to_file`: 是否输出到文件，默认为 True（输出到 `logs/api.log`）
  - `log_to_console`: 是否输出到控制台，默认为 False
  - `log_format`: 日志格式，如果为 None 则使用默认格式 `'%(asctime)s - %(name)s - %(levelname)s - %(message)s'`
  - 自动确保日志目录存在
  - 使用 `force=True` 强制重新配置，覆盖之前的配置

- `get_logger(name: str) -> logging.Logger`: 获取日志记录器实例
  - `name`: 日志记录器名称，通常使用 `__name__`
  - 返回配置好的 Logger 实例

**使用说明**:
- 所有模块应使用 `from core.logging import get_logger` 获取日志记录器
- 避免直接使用 `logging.getLogger()` 或 `logging.basicConfig()`
- 在 `main.py` 中可以调用 `setup_logging(log_to_console=True)` 同时输出到控制台
- 日志文件位置：`logs/api.log`（由 `core.config.LOG_FILE` 定义）

**使用示例**:
```python
from core.logging import get_logger

logger = get_logger(__name__)
logger.info("这是一条信息日志")
logger.error("这是一条错误日志")
```

#### **exceptions.py** - 统一异常定义

项目统一的异常类定义，所有模块都应从此模块导入异常类，避免重复定义。

**类**:
- `FinanceException(Exception)`: 财务系统基础异常类
  - 所有财务相关异常的基类
  - 使用示例: `raise FinanceException("错误消息")`

- `OrderException(FinanceException)`: 订单相关异常（继承自 FinanceException）
  - 用于订单相关的业务异常
  - 使用示例: `raise OrderException("订单不存在")`

- `InsufficientBalanceException(FinanceException)`: 余额不足异常
  - `__init__(account_type: str, required_amount, balance)`: 初始化异常
    - `account_type`: 账户类型（如 "user:123:promotion_balance" 或 "public_welfare"）
    - `required_amount`: 需要的金额
    - `balance`: 当前余额
  - 自动生成错误消息: "账户 {account_type} 余额不足: 需要 {required_amount}, 当前 {balance}"
  - 使用示例: `raise InsufficientBalanceException(account_type, required_amount, balance)`

**使用说明**:
- 所有服务层和 API 层都应从 `core.exceptions` 导入异常类
- 避免在服务模块中重复定义异常类
- 保持异常类定义的一致性

---

### 📁 services/ - 业务逻辑层

服务层包含所有核心业务逻辑，负责处理复杂的业务规则和数据操作。

#### **finance_service.py** - 财务服务（核心业务逻辑）

财务系统的核心服务类，所有异常类统一从 `core.exceptions` 导入。

**类**:
- `FinanceService`: 财务系统的核心服务类
  - `__init__(session: Optional[PyMySQLAdapter] = None)`: 初始化财务服务，可传入数据库会话适配器
  - `_check_pool_balance(account_type: str, required_amount: Decimal) -> bool`: 检查账户池余额是否充足
  - `_check_user_balance(user_id: int, required_amount: Decimal, balance_type: str = 'promotion_balance') -> bool`: 检查用户余额是否充足
  - `check_purchase_limit(user_id: int) -> bool`: 检查用户每日购买限制
  - `get_account_balance(account_type: str) -> Decimal`: 获取账户池余额
  - `get_user_balance(user_id: int, balance_type: str = 'promotion_balance') -> Decimal`: 获取用户余额
  - `settle_order(order_no: str, user_id: int, product_id: int, quantity: int = 1, points_to_use: int = 0) -> int`: 订单结算（核心业务逻辑）
    - 处理会员订单和普通订单
    - 积分抵扣计算
    - 资金分配到各个账户池
    - 积分奖励计算
    - 推荐奖励和团队奖励处理
  - `refund_order(order_no: str, reason: str = '') -> bool`: 订单退款
    - 退款金额计算
    - 资金回退
    - 积分回退
  - `distribute_weekly_subsidy()` -> dict`: 发放周补贴
    - 周补贴自动发放
    - 积分转优惠券
    - 补贴池资金管理
  - `apply_withdrawal(user_id: int, amount: float, withdrawal_type: str = 'user') -> Optional[int]`: 申请提现
    - 提现申请处理
    - 税费计算
  - `audit_withdrawal(withdrawal_id: int, approve: bool, remark: str = '') -> bool`: 审核提现
    - 提现审核流程
    - 资金划转
  - `audit_rewards(reward_ids: List[int], approve: bool) -> dict`: 批量审核奖励
    - 奖励转优惠券
  - `get_account_flow(account_type: str, page: int = 1, size: int = 20) -> dict`: 获取账户流水记录
  - `get_points_log(user_id: int, points_type: str = 'member', page: int = 1, size: int = 20) -> dict`: 获取积分流水记录
  - `get_finance_report(start_date: str, end_date: str) -> dict`: 生成财务报表
  - `get_points_deduction_report(start_date: str, end_date: str) -> dict`: 生成积分抵扣明细报表
  - 其他私有方法用于内部业务逻辑处理

**独立函数**:
- `split_order_funds(order_number: str, total: Decimal, is_vip: bool)`: 订单资金拆分
- `reverse_split_on_refund(order_number: str)`: 退款时反向拆分资金
- `get_balance(merchant_id: int = 1)`: 获取商家余额
- `bind_bank(bank_name: str, bank_account: str, merchant_id: int = 1)`: 绑定银行卡
- `withdraw(amount: Decimal, merchant_id: int = 1) -> bool`: 商家提现
- `settle_to_merchant(amount: Decimal, merchant_id: int = 1)`: 结算给商家
- `generate_statement()`: 生成对账单
- `save_image(file: UploadFile, folder: Path, max_size: tuple, max_mb: int, quality: int) -> str`: 保存图片文件
- `calc_max_points_per_item(unit_price_yuan: float, max_points_set: int) -> int`: 计算每件商品最大可用积分

#### **user_service.py** - 用户服务

**枚举类**:
- `UserStatus(IntEnum)`: 用户状态枚举
  - `NORMAL = 0`: 正常
  - `FROZEN = 1`: 冻结（不能登录、不能下单）
  - `DELETED = 2`: 已注销（逻辑删除）

**函数**:
- `hash_pwd(pwd: str) -> str`: 密码加密（使用 bcrypt）
- `verify_pwd(pwd: str, hashed: str) -> bool`: 密码校验
- `_generate_code(length: int = 6) -> str`: 生成 6 位不含 0O1I 的随机推荐码

**类**:
- `UserService`: 用户服务类
  - `register(mobile: str, pwd: str, name: Optional[str] = None, referrer_mobile: Optional[str] = None) -> int`: 用户注册
    - 检查手机号是否已注册
    - 生成唯一推荐码
    - 插入用户记录
    - 绑定推荐人（如果提供）
  - `login(mobile: str, pwd: str) -> dict`: 用户登录
    - 验证手机号和密码
    - 检查用户状态（冻结/注销）
    - 返回用户 ID、等级、token
  - `upgrade_one_star(mobile: str) -> int`: 用户升级一星
  - `set_member_level(user_id: int, level: int) -> bool`: 设置用户会员等级
  - `set_status(user_id: int, status: int) -> bool`: 设置用户状态
  - `update_profile(user_id: int, name: Optional[str] = None, avatar: Optional[str] = None, password: Optional[str] = None) -> bool`: 更新用户资料
  - `reset_password(mobile: str, new_password: str) -> bool`: 重置密码
  - `get_user_info(user_id: int) -> Optional[dict]`: 获取用户信息
  - `get_user_list(page: int = 1, size: int = 10, status: Optional[int] = None, level: Optional[int] = None) -> dict`: 分页查询用户列表
  - `bind_referrer(user_id: int, referrer_mobile: str) -> bool`: 绑定推荐人
  - `get_referrer(user_id: int) -> Optional[dict]`: 获取推荐人信息
  - `get_direct_referrals(user_id: int, page: int = 1, size: int = 10) -> dict`: 获取直推列表
  - `get_team_referrals(user_id: int, max_layer: int = 6) -> list`: 获取团队列表（递归）

#### **wechat_service.py** - 微信登录服务

**类**:
- `WechatService`: 微信登录服务类
  - `ensure_openid_column()`: 确保 users 表存在 openid 字段（兼容旧库）
  - `check_user_by_openid(openid: str) -> Optional[Dict[str, Any]]`: 通过 openid 查询用户
  - `register_user(openid: str, nick_name: str) -> int`: 为微信用户创建账号，自动生成必填字段
    - 生成占位手机号（保证唯一）
    - 生成随机密码
    - 生成唯一推荐码
    - 插入用户记录
  - `get_openid_by_code(code: str) -> tuple[str, str]`: 通过 code 换取 openid 和 session_key
    - 调用微信 API 接口
    - 返回 openid 和 session_key
  - `generate_token(user_id: int) -> str`: 生成 JWT token 用于用户认证
    - Token 有效期 1 天
    - 使用 HS256 算法

#### **address_service.py** - 地址服务

**类**:
- `AddressService`: 地址服务类
  - `add_address(user_id: int, name: str, phone: str, province: str, city: str, district: str, detail: str, is_default: bool = False, addr_type: str = "shipping") -> int`: 新增地址
    - 如果设置为默认地址，会取消其他默认地址
  - `delete_address(user_id: int, addr_id: int) -> None`: 删除地址
    - 检查地址是否存在和权限
  - `update_address(user_id: int, addr_id: int, **kwargs) -> None`: 更新地址
    - 支持部分字段更新
    - 如果设置为默认地址，会取消其他默认地址
  - `get_address_list(user_id: int, page: int = 1, size: int = 10) -> list`: 分页查询地址列表
    - 按默认地址优先、ID 倒序排列
  - `get_default_address(user_id: int) -> Optional[dict]`: 获取默认地址

#### **points_service.py** - 积分服务

**函数**:
- `add_points(user_id: int, points_type: str, amount: int, reason: str = "系统赠送")`: 积分变动：写流水 + 更新余额
  - 支持 `member`（用户积分）和 `merchant`（商家积分）两种类型
  - 自动更新用户积分余额
  - 记录积分流水

#### **reward_service.py** - 奖励服务

**类**:
- `TeamRewardService`: 团队奖励服务类
  - `add_reward(user_id: int, from_user_id: int, layer: int, amount: float, order_id: Optional[int] = None)`: 添加团队奖励记录
  - `get_reward_list_by_user(user_id: int, page: int = 1, size: int = 10)`: 获取用户的团队奖励列表（分页）
  - `get_reward_by_order(order_id: int)`: 按订单查询团队奖励

#### **director_service.py** - 董事服务

**类**:
- `DirectorService`: 荣誉董事服务类
  - `_refresh_six_counter()`: 刷新用户六星计数（后台每天或每周跑）
    - 更新直推六星人数
    - 更新团队六星人数
  - `try_promote(user_id: int) -> bool`: 单次晋升尝试，返回是否成功
    - 检查用户是否达到晋升条件（六星 + 直推3个六星 + 团队10个六星）
    - 如果符合条件，插入或更新 directors 表
  - `calc_week_dividend(period: datetime.date) -> Decimal`: 计算并发放本周荣誉董事分红
    - 计算本周新业绩（会员+普通商品销售额）
    - 计算分红池（2% 加权池）
    - 按团队六星人数线性加权分配
    - 发放分红到用户可提现余额
    - 返回总发放金额
  - `is_director(user_id: int) -> bool`: 查询用户是否是荣誉董事
  - `get_dividend_detail(user_id: int, page=1, size=10) -> List[Dict]`: 获取用户分红明细（分页）
  - `list_all_directors(page=1, size=10)`: 列出所有活跃董事（分页）

---

### 📁 models/ - 数据模型层

数据模型层定义所有的 Pydantic Schema，用于 API 请求和响应的数据验证。

#### 📁 models/schemas/ - 数据模式定义

**finance.py** - 财务系统相关的数据模型
- 订单结算请求/响应模型
- 退款请求/响应模型
- 提现请求/响应模型
- 财务报表响应模型
- 账户流水模型
- 奖励审核请求模型
- 补贴发放请求模型

**user.py** - 用户中心相关的数据模型
- 用户认证请求/响应模型（`AuthReq`, `AuthResp`）
- 用户信息模型（`UserInfoResp`）
- 用户状态更新模型（`SetStatusReq`, `FreezeReq`）
- 地址模型（`AddressReq`, `AddressResp`）
- 积分模型（`PointsReq`, `PointsResp`）
- 推荐关系模型
- 董事相关模型

**order.py** - 订单系统相关的数据模型
- 订单创建请求/响应模型
- 订单详情模型
- 购物车模型
- 退款模型
- 订单状态更新模型

**product.py** - 商品管理相关的数据模型
- 商品信息模型
- 商品创建/更新请求模型
- 商品搜索请求模型
- 商品列表响应模型
- 图片上传响应模型

---

### 📁 assets/ - 静态资源文件

存放项目使用的静态资源文件，如图片、文档等。

---

### 📁 logs/ - 日志文件目录

存放应用运行时的日志文件，默认日志文件为 `logs/api.log`。

---

## 根目录文件说明

### **main.py** - 应用入口文件

**全局变量**:
- `app: FastAPI`: FastAPI 应用实例
- `tags_metadata: list`: OpenAPI Tags 元数据列表

**函数**:
- `ensure_database()`: 确保数据库存在，不存在则自动创建并初始化
- `custom_openapi()`: 自定义 OpenAPI Schema 生成函数
  - **重要**：必须在路由注册之后设置，否则 schema 中不会包含路由
  - 过滤未定义的标签
  - 确保所有路径的 tags 都在定义的标签列表中
  - 根据内容自动替换标签

**应用配置**:
- 创建 FastAPI 实例，配置应用元数据、文档地址
- 设置 OpenAPI Tags 元数据
- 注册 CORS 和静态文件中间件
- **注册所有模块的路由**（必须在设置 custom_openapi 之前注册，确保路由包含在 OpenAPI schema 中）：
  - `register_finance_routes(app)` - 财务系统路由
  - `register_user_routes(app)` - 用户中心路由
  - `register_order_routes(app)` - 订单系统路由
  - `register_product_routes(app)` - 商品管理路由
- **设置自定义 OpenAPI Schema 生成函数**（必须在路由注册之后设置）

**启动逻辑**:
- 初始化数据库表结构
- 确保数据库存在
- 使用 uvicorn 启动 ASGI 服务器，支持热重载

### **database_setup.py** - 数据库初始化脚本

**类**:
- `DatabaseManager`: 数据库管理器类
  - `__init__()`: 初始化管理器，自动确保数据库存在
  - `_ensure_database_exists()`: 确保数据库存在，不存在则创建
  - `init_all_tables(cursor)`: 初始化所有数据表结构
    - 创建 users, products, orders, finance_accounts, account_flow, points_log, coupons, withdrawals, pending_rewards, team_rewards, weekly_subsidy_records, user_referrals, addresses, order_items, refunds, directors, director_dividends, order_split 等表
    - **注意**：users 表包含 `is_merchant` 字段用于标识商家身份
    - **注意**：地址表统一使用 `addresses` 表（不再使用 `user_addresses` 表）
  - `add_foreign_keys(cursor)`: 添加外键约束
  - `create_test_data(cursor, conn)`: 创建测试数据（可选）

**函数**:
- `create_database()`: 创建数据库（如果不存在）
- `initialize_database()`: 数据库初始化主函数
  - 创建数据库
  - 创建所有表
  - 添加外键
  - 创建测试数据（可选）
- `create_test_data()`: 创建测试数据的独立函数
- `init_db()`: 初始化数据库的便捷函数
- `auto_receive_task(db_cfg: dict = None)`: 自动收货守护进程（后台任务）
  - 自动将超过 7 天的待收货订单标记为已完成
- `_fix_pinyin()`: 补全商品拼音
  - 检查所有商品，如果 pinyin 字段为空，则自动生成拼音
  - 可重复执行，幂等操作
  - 需要 pypinyin 库支持

**表结构**: 定义了完整的数据库表结构，包括：
- `users` - 用户表（手机号、密码、会员等级、积分、余额、商家标识等）
  - 包含 `is_merchant` 字段用于标识是否为商家
- `products` - 商品表（SKU、名称、价格、库存、图片等）
- `orders` - 订单表（订单号、用户、商家、金额、状态等）
- `finance_accounts` - 财务账户表（账户类型、余额等）
- `account_flow` - 资金流水表
- `points_log` - 积分流水表
- `coupons` - 优惠券表
- `withdrawals` - 提现记录表
- `pending_rewards` - 待审核奖励表
- `team_rewards` - 团队奖励表
- `weekly_subsidy_records` - 周补贴记录表
- `user_referrals` - 用户推荐关系表
- `addresses` - 用户地址表（统一使用此表，不再使用 `user_addresses` 表）
  - 字段：name, phone, province, city, district, detail, is_default, addr_type
  - 支持购物地址和退货地址两种类型
- `order_items` - 订单商品明细表
- `refunds` - 退款表
- `directors` - 荣誉董事表
- `director_dividends` - 董事分红明细表
- `order_split` - 订单资金拆分表

### **pyproject.toml** - 项目依赖配置

Python 项目配置文件，定义：
- 项目元数据（名称、版本、描述）
- Python 版本要求 (>=3.13)
- 项目依赖列表（FastAPI, Pydantic, PyMySQL, uvicorn, bcrypt, requests, PyJWT, Pillow, pypinyin, python-multipart）
- PyPI 镜像源配置（阿里云镜像）
- 项目 README 文件

### **README.md** - 项目说明文档

项目的基本使用说明，包括：
- 安装依赖
- 启动应用
- API 文档访问地址
- 环境变量配置示例

### **uv.lock** - 依赖锁定文件

由 `uv` 包管理器生成的依赖锁定文件，确保依赖版本的一致性。

### **.gitignore** - Git 忽略文件

定义 Git 版本控制中需要忽略的文件和目录，包括：
- Python 缓存文件 (`__pycache__/`, `*.pyc`)
- IDE 配置文件 (`.vscode/`)
- 构建产物 (`build/`, `dist/`)
- 虚拟环境 (`.venv`)
- 环境变量文件 (`.env`)
- 日志文件 (`*.log`)

---

## 架构设计说明

### 分层架构

项目采用经典的分层架构设计：

```
┌─────────────────────────────────────┐
│         API Layer (api/)            │  ← HTTP 请求处理、参数验证
├─────────────────────────────────────┤
│      Service Layer (services/)     │  ← 业务逻辑处理
├─────────────────────────────────────┤
│      Model Layer (models/)          │  ← 数据模型定义
├─────────────────────────────────────┤
│      Core Layer (core/)             │  ← 基础设施（数据库、配置、中间件）
└─────────────────────────────────────┘
```

### 数据流向

1. **请求流程**: 
   ```
   HTTP Request → API Route → Service → Database → Response
   ```

2. **数据库操作**: 
   ```
   Service → core.database.get_conn() → PyMySQL → MySQL Database
   ```

3. **配置管理**: 
   ```
   Application → core.config → Environment Variables (.env)
   ```

### 模块划分

- **财务系统**: `api/finance/` + `services/finance_service.py`
- **用户中心**: `api/user/` + `services/user_service.py` + `services/wechat_service.py`
- **订单系统**: `api/order/`（包含购物车、订单、退款、商家等功能）
- **地址管理**: 统一使用 `api/user/routes.py` + `services/address_service.py`（已从订单系统移除）
- **商品管理**: `api/product/` + 相关服务

### 设计模式

- **依赖注入**: FastAPI 的 `Depends()` 用于服务实例注入
- **上下文管理器**: 数据库连接使用上下文管理器自动管理事务
- **适配器模式**: `PyMySQLAdapter` 适配 SQLAlchemy 接口到 PyMySQL
- **工厂模式**: 服务类通过工厂函数创建实例

---

## 环境变量配置

项目通过 `.env` 文件管理配置，需要配置以下环境变量：

```env
# 数据库配置（必需）
MYSQL_HOST=127.0.0.1
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=finan_manage_db

# 微信小程序配置（可选，用于微信登录功能）
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret
```

---

## 启动说明

1. **安装依赖**:
   ```bash
   pip install -r requirements.txt
   # 或使用 uv
   uv pip install -r requirements.txt
   ```

2. **配置环境变量**: 创建 `.env` 文件并配置数据库连接信息

3. **启动应用**:
   ```bash
   python main.py
   ```

4. **访问 API 文档**:
   - Swagger UI: http://127.0.0.1:8000/docs
   - ReDoc: http://127.0.0.1:8000/redoc

---

## 注意事项

1. **数据库初始化**: 首次运行时会自动创建数据库和表结构
2. **日志文件**: 日志默认输出到 `logs/api.log`，需要确保 `logs/` 目录存在
3. **静态文件**: 如果存在 `static/` 目录，会自动挂载到 `/static` 路径
4. **事务管理**: 所有数据库操作都通过上下文管理器自动管理事务，失败时自动回滚
5. **密码加密**: 用户密码使用 bcrypt 进行加密存储，不可逆
6. **JWT Token**: 微信登录使用 JWT Token 进行用户认证，有效期 1 天
7. **图片上传**: 图片上传目录为 `pic_data/`，需要确保目录存在且有写权限
8. **拼音功能**: 商品拼音补全功能需要安装 `pypinyin` 库
9. **自动收货**: 系统包含自动收货守护进程，会自动将超过 7 天的待收货订单标记为已完成

---

## 更新日志

- **移除 SQLAlchemy**: 项目已完全移除 SQLAlchemy ORM，使用纯 PyMySQL
- **分层架构重构**: 项目已重构为清晰的分层架构
- **统一配置管理**: 所有配置统一在 `core/config.py` 管理
- **统一数据库连接**: 所有数据库操作通过 `core/database.get_conn()` 统一管理
- **添加依赖**: 新增 Pillow、pypinyin、python-multipart 依赖
- **优化文档**: 完善项目结构说明文档，添加详细的类和函数说明
- **地址功能统一**: 将订单系统的地址功能统一整合到用户系统，统一使用 `addresses` 表
- **数据库表优化**: 
  - users 表新增 `is_merchant` 字段用于标识商家身份
  - 统一使用 `addresses` 表替代 `user_addresses` 表
- **OpenAPI Schema 修复**: 修复路由注册顺序问题，确保所有路由正确显示在 API 文档中
- **导入优化**: `requests` 库改为延迟导入，解决 Windows multiprocessing 导入问题

---

*最后更新: 2025-01-XX*
